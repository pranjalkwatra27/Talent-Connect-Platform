<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Profile - TalentConnect</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }

    body {
      background: #f9fafb;
      min-height: 100vh;
      padding-bottom: 50px;
    }

    /* Header */
    header {
      background: #fff;
      padding: 22px 70px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo-container { display:flex; align-items:center; gap:10px; cursor:pointer; user-select:none; }
    .logo-text-left, .logo-text-right { color:#5b21b6; font-weight:800; font-size:26px; letter-spacing:0.5px; }
    .logo-container img { height:45px; width:45px; object-fit:contain; display:block; }
    .back-btn {
      padding:10px 20px; background:#5b21b6; color:#fff; border:none; border-radius:8px;
      cursor:pointer; font-weight:600; transition:0.25s;
    }
    .back-btn:hover { background:#7c3aed; transform:translateY(-1px); }

    /* Container */
    .container { max-width:900px; margin:40px auto; padding:0 20px; }

    .profile-header {
      background: linear-gradient(135deg,#5b21b6 0%,#7c3aed 100%);
      border-radius:20px; padding:40px; text-align:center; color:#fff; margin-bottom:30px;
    }

    .profile-avatar {
      width:120px; height:120px; border-radius:50%; background:#fff; display:flex;
      align-items:center; justify-content:center; margin:0 auto 20px; font-size:50px;
      color:#5b21b6; border:5px solid rgba(255,255,255,0.3);
    }

    .profile-header h1 { font-size:32px; margin-bottom:8px; }
    .profile-header p { opacity:0.9; font-size:16px; }
    .badge { display:inline-block; padding:6px 16px; background:rgba(255,255,255,0.2); border-radius:20px; font-size:14px; margin-top:12px; }

    /* Stats Grid */
    .stats-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:20px; margin-bottom:30px; }
    .stat-card {
      background:#fff; padding:24px; border-radius:16px; box-shadow:0 4px 20px rgba(0,0,0,0.06); text-align:center;
    }
    .stat-card i { font-size:36px; color:#5b21b6; margin-bottom:12px; }
    .stat-card h3 { font-size:32px; color:#1f2937; margin-bottom:4px; }
    .stat-card p { color:#6b7280; font-size:14px; }

    /* Profile Card / Forms */
    .profile-card {
      background:#fff; border-radius:16px; padding:30px; box-shadow:0 4px 20px rgba(0,0,0,0.06); margin-bottom:20px;
    }
    .profile-card h2 { color:#1f2937; font-size:24px; margin-bottom:20px; display:flex; align-items:center; gap:10px; }
    .profile-card h2 i { color:#5b21b6; }

    .form-group { margin-bottom:20px; }
    label { display:block; color:#374151; font-weight:600; margin-bottom:8px; font-size:14px; }
    input, textarea, select {
      width:100%; padding:14px 16px; border-radius:10px; border:2px solid #e5e7eb; font-size:15px; outline:none; transition:0.2s;
    }
    input:focus, textarea:focus, select:focus { border-color:#5b21b6; box-shadow:0 0 0 3px rgba(91,33,182,0.08); }
    input[disabled] { background:#f3f4f6; cursor:not-allowed; }

    .form-row { display:grid; grid-template-columns:1fr 1fr; gap:20px; }

    .btn { padding:14px 28px; border-radius:10px; border:none; font-weight:600; cursor:pointer; font-size:15px; transition:0.2s; }
    .btn-primary { background:#5b21b6; color:#fff; }
    .btn-primary:hover { background:#7c3aed; transform:translateY(-2px); box-shadow:0 8px 20px rgba(91,33,182,0.18); }
    .btn-secondary { background:#e5e7eb; color:#374151; }
    .btn-secondary:hover { background:#d1d5db; }

    .btn-group { display:flex; gap:12px; margin-top:25px; }

    .alert { padding:14px 18px; border-radius:10px; margin-bottom:20px; display:none; animation:slideIn .25s; }
    .alert.active { display:block; }
    .alert-success { background:#d1fae5; color:#065f46; border-left:4px solid #10b981; }
    .alert-error { background:#fee2e2; color:#991b1b; border-left:4px solid #ef4444; }

    @keyframes slideIn { from{opacity:0; transform:translateY(-8px);} to{opacity:1; transform:none;} }

    /* Responsive */
    @media (max-width: 768px) {
      header { padding:15px 20px; }
      .logo-text-left, .logo-text-right { font-size:20px; }
      .logo-container img { height:35px; width:35px; }
      .form-row { grid-template-columns:1fr; }
      .btn-group { flex-direction:column; }
      .btn { width:100%; }
      .container { padding:0 15px; }
    }
  </style>
</head>
<body>

  <header>
    <div class="logo-container" onclick="goHome()" title="Go to home">
      <span class="logo-text-left">TALENT</span>
      <!-- Put your logo file named exactly `your-logo.png` in the same folder as this file -->
      <img src="logo.png" alt="TalentConnect logo" />
      <span class="logo-text-right">CONNECT</span>
    </div>

    <button class="back-btn" onclick="goBack()">
      <i class="fas fa-arrow-left"></i> Back to Home
    </button>
  </header>

  <div class="container">
    <div id="alertBox" class="alert"></div>

    <div class="profile-header">
      <div class="profile-avatar">
        <i class="fas fa-user-circle"></i>
      </div>
      <h1 id="profileName">Loading...</h1>
      <p id="profileEmail">Loading...</p>
      <span class="badge" id="userTypeBadge"><i class="fas fa-user"></i> Customer</span>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <i class="fas fa-calendar-check"></i>
        <h3 id="totalBookings">0</h3>
        <p>Total Bookings</p>
      </div>
      <div class="stat-card">
        <i class="fas fa-clock"></i>
        <h3 id="upcomingEvents">0</h3>
        <p>Upcoming Events</p>
      </div>
      <div class="stat-card">
        <i class="fas fa-calendar-day"></i>
        <h3 id="memberSince">2025</h3>
        <p>Member Since</p>
      </div>
    </div>

    <div class="profile-card">
      <h2><i class="fas fa-user-edit"></i> Personal Information</h2>
      <form id="profileForm" onsubmit="updateProfile(event)">
        <div class="form-group">
          <label for="fullName">Full Name</label>
          <input type="text" id="fullName" placeholder="Enter your full name" required />
        </div>

        <div class="form-group">
          <label for="email">Email Address</label>
          <input type="email" id="email" placeholder="Enter your email" disabled />
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="phone">Phone Number (Optional)</label>
            <input type="tel" id="phone" placeholder="+91 1234567890" />
          </div>

          <div class="form-group">
            <label for="location">Location (Optional)</label>
            <input type="text" id="location" placeholder="City, State" />
          </div>
        </div>

        <div class="btn-group">
          <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save Changes</button>
          <button type="button" class="btn btn-secondary" onclick="resetForm()"><i class="fas fa-undo"></i> Reset</button>
        </div>
      </form>
    </div>

    <div class="profile-card">
      <h2><i class="fas fa-lock"></i> Change Password</h2>
      <form id="passwordForm" onsubmit="changePassword(event)">
        <div class="form-group">
          <label for="currentPassword">Current Password</label>
          <input type="password" id="currentPassword" placeholder="Enter current password" required />
        </div>

        <div class="form-group">
          <label for="newPassword">New Password</label>
          <input type="password" id="newPassword" placeholder="Enter new password (min 6 characters)" minlength="6" required />
        </div>

        <div class="form-group">
          <label for="confirmPassword">Confirm New Password</label>
          <input type="password" id="confirmPassword" placeholder="Confirm new password" minlength="6" required />
        </div>

        <button type="submit" class="btn btn-primary"><i class="fas fa-key"></i> Update Password</button>
      </form>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    // ---------- Firebase Configuration (from you) ----------
    const firebaseConfig = {
      apiKey: "AIzaSyBE5yRL0Vx6a1asXMMioEr3t9Ah2w3QxtM",
      authDomain: "talent-f474d.firebaseapp.com",
      projectId: "talent-f474d",
      storageBucket: "talent-f474d.firebasestorage.app",
      messagingSenderId: "826760976811",
      appId: "1:826760976811:web:34c70fe2619bd047885aee",
      measurementId: "G-7L12448Y3H",
      databaseURL: "https://talent-f474d-default-rtdb.firebaseio.com"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // ---------- State ----------
    let currentUser = null;
    let originalData = {};

    // ---------- Auth Observer ----------
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        currentUser = user;
        await loadUserProfile(user.uid);
      } else {
        // Not logged in â€” send to login
        window.location.href = 'login.html';
      }
    });

    // ---------- Load User Profile ----------
    async function loadUserProfile(uid) {
      try {
        const snapshot = await db.ref(`users/${uid}`).once('value');
        const userData = snapshot.val();

        if (!userData) throw new Error('User data not found');

        originalData = { ...userData };

        // UI updates
        document.getElementById('profileName').textContent = userData.name || 'Your name';
        document.getElementById('profileEmail').textContent = userData.email || '';
        document.getElementById('fullName').value = userData.name || '';
        document.getElementById('email').value = userData.email || '';
        document.getElementById('phone').value = userData.phone || '';
        document.getElementById('location').value = userData.location || '';

        const badge = document.getElementById('userTypeBadge');
        if (userData.userType === 'organizer') {
          badge.innerHTML = '<i class="fas fa-calendar-plus"></i> Organizer';
        } else {
          badge.innerHTML = '<i class="fas fa-user"></i> Customer';
        }

        // memberSince
        try {
          if (userData.createdAt) {
            document.getElementById('memberSince').textContent = new Date(userData.createdAt).getFullYear();
          }
        } catch (e) {}

        // load booking stats
        await loadBookingStats(uid);

      } catch (error) {
        console.error('Error loading profile:', error);
        showAlert('Failed to load profile data', 'error');
      }
    }

    // ---------- Load Booking Stats ----------
    async function loadBookingStats(uid) {
      try {
        const snapshot = await db.ref(`bookings/${uid}`).once('value');
        const bookings = snapshot.val();

        if (!bookings) {
          document.getElementById('totalBookings').textContent = 0;
          document.getElementById('upcomingEvents').textContent = 0;
          return;
        }

        const bookingArray = Object.values(bookings || {});
        document.getElementById('totalBookings').textContent = bookingArray.length;

        const upcoming = bookingArray.filter(b => {
          try {
            const d = new Date(b.eventDate);
            return d > new Date();
          } catch (e) {
            return false;
          }
        }).length;
        document.getElementById('upcomingEvents').textContent = upcoming;

      } catch (error) {
        console.error('Error loading booking stats:', error);
      }
    }

    // ---------- Update Profile ----------
    async function updateProfile(event) {
      event.preventDefault();

      const name = document.getElementById('fullName').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const location = document.getElementById('location').value.trim();

      if (!name) {
        showAlert('Name is required', 'error');
        return;
      }

      try {
        // Update Firebase Auth display name
        if (currentUser && currentUser.updateProfile) {
          await currentUser.updateProfile({ displayName: name });
        }

        // Update Realtime DB
        await db.ref(`users/${currentUser.uid}`).update({
          name,
          phone,
          location,
          updatedAt: new Date().toISOString()
        });

        // local UI
        document.getElementById('profileName').textContent = name;
        originalData.name = name;
        originalData.phone = phone;
        originalData.location = location;

        showAlert('Profile updated successfully!', 'success');
      } catch (error) {
        console.error('Error updating profile:', error);
        showAlert('Failed to update profile. Please try again.', 'error');
      }
    }

    // ---------- Change Password ----------
    async function changePassword(event) {
      event.preventDefault();

      const currentPassword = document.getElementById('currentPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;

      if (newPassword !== confirmPassword) {
        showAlert('New passwords do not match', 'error');
        return;
      }
      if (newPassword.length < 6) {
        showAlert('Password must be at least 6 characters', 'error');
        return;
      }

      try {
        // Re-authenticate
        const credential = firebase.auth.EmailAuthProvider.credential(currentUser.email, currentPassword);
        await currentUser.reauthenticateWithCredential(credential);

        // Update password
        await currentUser.updatePassword(newPassword);

        showAlert('Password updated successfully!', 'success');
        document.getElementById('passwordForm').reset();
      } catch (error) {
        console.error('Error changing password:', error);
        let message = 'Failed to update password';
        if (error.code === 'auth/wrong-password') message = 'Current password is incorrect';
        if (error.code === 'auth/weak-password') message = 'New password is too weak';
        showAlert(message, 'error');
      }
    }

    // ---------- Reset Form ----------
    function resetForm() {
      document.getElementById('fullName').value = originalData.name || '';
      document.getElementById('phone').value = originalData.phone || '';
      document.getElementById('location').value = originalData.location || '';
      showAlert('Form reset to original values', 'success');
    }

    // ---------- Alerts ----------
    function showAlert(message, type = 'success') {
      const alertBox = document.getElementById('alertBox');
      alertBox.textContent = message;
      alertBox.className = `alert alert-${type} active`;
      if (type === 'success') alertBox.classList.add('alert-success');
      if (type === 'error') alertBox.classList.add('alert-error');

      setTimeout(() => {
        alertBox.classList.remove('active');
        alertBox.classList.remove('alert-success');
        alertBox.classList.remove('alert-error');
      }, 4500);
    }

    // ---------- Navigation helpers ----------
    function goBack() { window.location.href = 'index.html'; }
    function goHome() { window.location.href = 'index.html'; }

    // ---------- Simple defensive checks for form submits in older browsers ----------
    (function attachForms() {
      const pf = document.getElementById('profileForm');
      if (pf) pf.addEventListener('submit', updateProfile);

      const pw = document.getElementById('passwordForm');
      if (pw) pw.addEventListener('submit', changePassword);
    })();
  </script>
</body>
</html>
